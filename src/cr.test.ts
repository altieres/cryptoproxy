class Kline {
  time: number = 0
  open: number = 0
  high: number = 0
  low: number = 0
  close: number = 0

  constructor(init: Kline | null = null) {
    if (init !== null) Object.assign(this, init)
  }
}

describe('simple average computation', () => {
  test('one kline', () => {
    expect(computeAverageForElement({ startValue: 5000, candle: btcusdt1h[0] })).toEqual(new Kline({ time: 1640995200000, open: 2.00000000, high: 2.20000000, low: 1.60000000, close: 1.80000000 }))
  })

  test('tow klines, same changes', () => {
    expect(computeAverageForCandle([{ startValue: 5000, candle: btcusdt1h[0] }, { startValue: 500, candle: ethusdt1h[0] }])).toEqual(new Kline({ time: 1640995200000, open: 2.00000000, high: 2.20000000, low: 1.60000000, close: 1.80000000 }))
  })

  test('tow klines, different changes', () => {
    expect(computeAverageForCandle([{ startValue: 5000, candle: btcusdt1h[0] }, { startValue: 1000, candle: ethusdt1h[0] }])).toEqual(new Kline({ time: 1640995200000, open: 1.50000000, high: 1.65000000, low: 1.20000000, close: 1.35000000 }))
  })
})

export { }

const computeAverageForCandle = (elements: Array<{ startValue: number, candle: any }>): Kline => {
  const n = elements.length

  return elements.map(computeAverageForElement).reduce((prv, curr) => new Kline({
    time: curr.time,
    open: parseFloat((prv.open + curr.open / n).toFixed(8)),
    high: parseFloat((prv.high + curr.high / n).toFixed(8)),
    low: parseFloat((prv.low + curr.low / n).toFixed(8)),
    close: parseFloat((prv.close + curr.close / n).toFixed(8)),
  }), new Kline())
}

const computeAverageForElement = ({ startValue, candle }: { startValue: number, candle: any }) => {
  return new Kline({
    time: candle[0],
    open: candle[1] / startValue,
    high: candle[2] / startValue,
    low: candle[3] / startValue,
    close: candle[4] / startValue,
  })
}

const btcusdt1h: Array<any> = [
  [1640995200000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641081599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641081600000, "10001.00000000", "11001.00000000", "8001.00000000", "9001.00000000", "2.00000000", 1641167999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641168000000, "10002.00000000", "11002.00000000", "8002.00000000", "9002.00000000", "2.00000000", 1641254399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641254400000, "10003.00000000", "11003.00000000", "8003.00000000", "9003.00000000", "2.00000000", 1641340799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641340800000, "10004.00000000", "11004.00000000", "8004.00000000", "9004.00000000", "2.00000000", 1641427199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641427200000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641513599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641513600000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641599999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641600000000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641686399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641686400000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641772799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641772800000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641859199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641859200000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1641945599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641945600000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642031999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642032000000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642118399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642118400000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642204799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642204800000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642291199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642291200000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642377599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642377600000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642463999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642464000000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642550399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642550400000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642636799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642636800000, "10000.00000000", "11000.00000000", "8000.00000000", "9000.00000000", "2.00000000", 1642723199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
]

const ethusdt1h = [
  [1640995200000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641081599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641081600000, "1001.00000000", "1101.00000000", "801.00000000", "901.00000000", "2.00000000", 1641167999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641168000000, "1002.00000000", "1102.00000000", "802.00000000", "902.00000000", "2.00000000", 1641254399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641254400000, "1003.00000000", "1103.00000000", "803.00000000", "903.00000000", "2.00000000", 1641340799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641340800000, "1004.00000000", "1104.00000000", "804.00000000", "904.00000000", "2.00000000", 1641427199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641427200000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641513599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641513600000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641599999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641600000000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641686399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641686400000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641772799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641772800000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641859199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641859200000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1641945599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1641945600000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642031999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642032000000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642118399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642118400000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642204799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642204800000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642291199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642291200000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642377599999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642377600000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642463999999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642464000000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642550399999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642550400000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642636799999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
  [1642636800000, "1000.00000000", "1100.00000000", "800.00000000", "900.00000000", "2.00000000", 1642723199999, "1.00000000", 1, "1.00000000", "1.00000000", "0"],
]
